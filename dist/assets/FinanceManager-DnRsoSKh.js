import{r,s as l,j as e,S as te}from"./index-EH-KDdP-.js";import{read as ne,utils as f,writeFile as se}from"./xlsx-D_0l8YDs.js";import{I as re}from"./ImportGuideModal-CMth416p.js";import{D as ae}from"./download-DrfUKMba.js";import{U as ie}from"./upload-ny2dlU1l.js";import{C as oe}from"./credit-card-BlaQXWoz.js";import{D as le}from"./dollar-sign-Bwdk2lfY.js";import{P as de}from"./printer-RRSzFfKc.js";import"./check-circle-DoFw_Y84.js";import"./x-circle-Bij7XsNB.js";const je=()=>{const[p,v]=r.useState("bursar"),[E,U]=r.useState([]),[w,k]=r.useState(""),[N,R]=r.useState([]),[a,C]=r.useState(null),[y,D]=r.useState(""),[d,T]=r.useState(null),[ce,o]=r.useState(!1),[I,P]=r.useState(""),[A,G]=r.useState([]),[O,b]=r.useState(!1),[S,M]=r.useState("");r.useEffect(()=>{z()},[]);const z=async()=>{const{data:t}=await l.from("fees_structure").select("*").order("class_name");U(t||[])},h=t=>new Intl.NumberFormat("en-UG",{style:"currency",currency:"UGX",minimumFractionDigits:0}).format(t||0),L=async t=>{t.preventDefault(),o(!0),C(null),T(null);let n=l.from("students").select("*").ilike("student_name",`%${w}%`);S&&(n=n.eq("class_grade",S));const{data:s,error:c}=await n;s&&R(s),o(!1)},F=async t=>{C(t),R([]),k(""),o(!0);const{data:n,error:s}=await l.rpc("get_student_balance",{student_uuid:t.id});T(n);const{data:c}=await l.from("fee_payments").select("*").eq("student_id",t.id).order("created_at",{ascending:!1}).limit(5);G(c||[]),o(!1)},q=async t=>{if(t.preventDefault(),!(!a||!y)){o(!0);try{const n=parseFloat(y),{error:s}=await l.from("fee_payments").insert([{student_id:a.id,amount_paid:n,payment_method:"cash",captured_by:null}]);if(s)throw s;P(`Payment of ${h(n)} recorded for ${a.student_name}`),D(""),F(a),setTimeout(()=>P(""),5e3)}catch(n){alert("Payment Error: "+n.message)}finally{o(!1)}}},X=async(t,n)=>{const{error:s}=await l.from("fees_structure").update({term_fee_amount:n}).eq("id",t);s?alert("Error updating fee"):z()},H=async()=>{const{data:t,error:n}=await l.from("students").select("student_reg_number, student_name, class_grade").order("class_grade",{ascending:!0}).order("student_name",{ascending:!0});if(n||!t||t.length===0){alert("No students found in database. Please add students first.");return}const s=t.map(u=>({"Reg No":u.student_reg_number,"Student Name":u.student_name,Class:u.class_grade,Amount:"",Date:new Date().toISOString().split("T")[0],"Ref No":""})),c=f.json_to_sheet(s),m=f.book_new();f.book_append_sheet(m,c,"Payments_Template"),se(m,`BHS_Payments_Template_${new Date().toISOString().split("T")[0]}.xlsx`)},J=t=>{if(!t)return new Date().toISOString();if(typeof t=="string"&&(t.includes("-")||t.includes("/")))return t;if(typeof t=="number"){const s=Math.floor(t-25569)*86400;return new Date(s*1e3).toISOString()}return new Date().toISOString()},V=t=>{const n=t.target.files[0];if(!n)return;o(!0);const s=new FileReader;s.onload=async c=>{try{const m=c.target.result,u=ne(m,{type:"binary"}),K=u.SheetNames[0],Q=u.Sheets[K],j=f.sheet_to_json(Q);if(j.length===0){alert("File is empty."),o(!1);return}const{data:Y}=await l.from("students").select("id, student_reg_number"),_={};Y.forEach(i=>{_[i.student_reg_number]=i.id});const g=[];let $=0;if(j.forEach(i=>{const x=i["Reg No"],B=i.Amount,Z=i.Date,ee=i["Ref No"];x&&_[x]&&B?g.push({student_id:_[x],amount_paid:B,payment_date:J(Z),payment_method:"cash",remarks:ee||"Imported via Bulk Upload"}):($++,console.warn(`Skipping row: RegNo ${x} not found or invalid data.`))}),g.length>0){const{error:i}=await l.from("fee_payments").insert(g);if(i)throw i;alert(`Successfully imported ${g.length} payments. Skiped ${$} invalid rows.`)}else alert(`No valid payments found. Checked ${j.length} rows.`)}catch(m){console.error(m),alert("Import Failed: "+m.message)}finally{o(!1),t.target.value=null}},s.readAsBinaryString(n)},W=t=>{const n=window.open("","Receipt","width=400,height=600");n.document.write(`
            <html>
                <body style="font-family: monospace; text-align: center; padding: 2rem;">
                    <h2>BUGISU HIGH SCHOOL</h2>
                    <p>Official Receipt</p>
                    <hr/>
                    <div style="text-align: left; margin: 20px 0;">
                        <p><strong>Receipt No:</strong> #${t.receipt_no}</p>
                        <p><strong>Date:</strong> ${new Date(t.created_at).toLocaleString()}</p>
                        <p><strong>Student:</strong> ${a.student_name}</p>
                        <p><strong>Reg No:</strong> ${a.student_reg_number}</p>
                    </div>
                    <hr/>
                    <h1>${h(t.amount_paid)}</h1>
                    <hr/>
                    <p>Paid via: ${t.payment_method}</p>
                    <p style="margin-top: 50px;">Thank you!</p>
                </body>
            </html>
        `),n.print()};return e.jsxs("div",{className:"admin-page-container",children:[O&&e.jsx(re,{type:"payments",onClose:()=>b(!1),onProceed:()=>{b(!1),document.getElementById("payments-file-input").click()}}),e.jsx("input",{id:"payments-file-input",type:"file",accept:".xlsx, .xls",onChange:V,style:{display:"none"}}),e.jsxs("div",{className:"admin-header",children:[e.jsx("h2",{children:"Finance & Fees Management"}),e.jsxs("div",{style:{display:"flex",gap:"10px"},children:[e.jsxs("div",{className:"bulk-actions",style:{display:"flex",gap:"5px",marginRight:"20px",paddingRight:"20px",borderRight:"1px solid #ddd"},children:[e.jsxs("button",{className:"btn btn-outline",onClick:H,title:"Download Excel Template",style:{padding:"0.4rem 0.8rem",fontSize:"0.8rem"},children:[e.jsx(ae,{size:14})," Template"]}),e.jsxs("label",{className:"btn btn-outline",style:{cursor:"pointer",padding:"0.4rem 0.8rem",fontSize:"0.8rem"},title:"Upload Payments",onClick:()=>b(!0),children:[e.jsx(ie,{size:14})," Import"]})]}),e.jsxs("button",{className:`btn ${p==="bursar"?"btn-primary":"btn-outline"}`,onClick:()=>v("bursar"),children:[e.jsx(oe,{size:18})," Bursar Station"]}),e.jsxs("button",{className:`btn ${p==="structure"?"btn-primary":"btn-outline"}`,onClick:()=>v("structure"),children:[e.jsx(le,{size:18})," Fee Structure"]})]})]}),p==="structure"&&e.jsxs("div",{className:"admin-content",children:[e.jsx("h3",{children:"Termly Fees per Class (UGX)"}),e.jsx("div",{className:"admin-list",children:E.map(t=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"1rem",background:"white",marginBottom:"0.5rem",alignItems:"center",borderRadius:"8px"},children:[e.jsx("strong",{children:t.class_name}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[e.jsx("span",{children:"UGX"}),e.jsx("input",{type:"number",defaultValue:t.term_fee_amount,onBlur:n=>X(t.id,n.target.value),style:{padding:"0.5rem",width:"120px",fontWeight:"bold"}})]})]},t.id))})]}),p==="bursar"&&e.jsxs("div",{className:"admin-content",style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"2rem"},children:[e.jsxs("div",{className:"bursar-left",children:[e.jsxs("div",{className:"search-bar",style:{display:"flex",gap:"0.5rem",marginBottom:"1rem"},children:[e.jsx("input",{type:"text",placeholder:"Search Student Name...",value:w,onChange:t=>k(t.target.value),style:{flex:1,padding:"0.75rem",borderRadius:"8px",border:"1px solid #ccc"}}),e.jsxs("select",{value:S,onChange:t=>M(t.target.value),style:{padding:"0.75rem",borderRadius:"8px",border:"1px solid #ccc",background:"white"},children:[e.jsx("option",{value:"",children:"All Classes"}),e.jsx("option",{value:"Senior 1",children:"Senior 1"}),e.jsx("option",{value:"Senior 2",children:"Senior 2"}),e.jsx("option",{value:"Senior 3",children:"Senior 3"}),e.jsx("option",{value:"Senior 4",children:"Senior 4"}),e.jsx("option",{value:"Senior 5",children:"Senior 5"}),e.jsx("option",{value:"Senior 6",children:"Senior 6"})]}),e.jsx("button",{className:"btn btn-primary",onClick:L,children:e.jsx(te,{size:18})})]}),N.length>0&&e.jsx("div",{className:"student-results-list",style:{background:"white",borderRadius:"8px",overflow:"hidden"},children:N.map(t=>e.jsxs("div",{onClick:()=>F(t),style:{padding:"0.75rem",cursor:"pointer",borderBottom:"1px solid #eee",hover:{background:"#f9f9f9"}},children:[e.jsx("strong",{children:t.student_name})," ",e.jsxs("span",{style:{color:"#666"},children:["(",t.class_grade,")"]})]},t.id))}),a&&e.jsxs("div",{className:"student-card",style:{background:"white",padding:"1.5rem",borderRadius:"12px",boxShadow:"0 2px 5px rgba(0,0,0,0.05)"},children:[e.jsx("h3",{children:a.student_name}),e.jsx("p",{style:{color:"#666"},children:a.student_reg_number}),e.jsx("hr",{style:{margin:"1rem 0",borderColor:"#eee"}}),e.jsxs("div",{style:{textAlign:"center",margin:"2rem 0"},children:[e.jsx("p",{style:{textTransform:"uppercase",fontSize:"0.8rem",color:"#666"},children:"Current Outstanding Balance"}),e.jsx("h1",{style:{fontSize:"2.5rem",color:d&&d>0?"#ef4444":"#22c55e",margin:"0.5rem 0"},children:h(d)}),d&&d>0&&e.jsx("span",{style:{background:"#fee2e2",color:"#b91c1c",padding:"4px 12px",borderRadius:"100px",fontSize:"0.8rem"},children:"NOT CLEARED"}),d!==null&&d<=0&&e.jsx("span",{style:{background:"#dcfce7",color:"#15803d",padding:"4px 12px",borderRadius:"100px",fontSize:"0.8rem"},children:"CLEARED"})]})]})]}),e.jsx("div",{className:"bursar-right",children:a?e.jsxs("div",{style:{background:"white",padding:"2rem",borderRadius:"12px"},children:[e.jsx("h4",{children:"Record New Payment"}),e.jsxs("form",{onSubmit:q,children:[e.jsxs("div",{style:{margin:"1rem 0"},children:[e.jsx("label",{style:{display:"block",marginBottom:"0.5rem"},children:"Amount (UGX)"}),e.jsx("input",{type:"number",value:y,onChange:t=>D(t.target.value),style:{width:"100%",padding:"1rem",fontSize:"1.2rem",borderRadius:"8px",border:"1px solid #ccc"},placeholder:"500000",required:!0})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",style:{width:"100%",padding:"1rem",fontSize:"1.1rem"},children:"Confirm Payment"})]}),I&&e.jsx("div",{style:{marginTop:"1rem",padding:"1rem",background:"#ecfdf5",color:"#047857",borderRadius:"8px",textAlign:"center"},children:I}),e.jsxs("div",{className:"recent-payments",style:{marginTop:"2rem"},children:[e.jsx("h5",{children:"Recent Transactions"}),A.map(t=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"0.75rem",borderBottom:"1px solid #eee",fontSize:"0.9rem"},children:[e.jsx("span",{children:new Date(t.created_at).toLocaleDateString()}),e.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[e.jsx("strong",{children:h(t.amount_paid)}),e.jsx("span",{style:{fontSize:"0.75rem",color:"#666",textTransform:"capitalize"},children:t.payment_method==="mobile_money"?"Mobile Money":t.payment_method})]}),e.jsx("button",{className:"btn-icon",onClick:()=>W(t),title:"Print Receipt",children:e.jsx(de,{size:14})})]},t.id))]})]}):e.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",color:"#94a3b8",border:"2px dashed #e2e8f0",borderRadius:"12px"},children:"Select a student to collect fees."})})]})]})};export{je as default};
