import{c as w,h as E,r as n,s as d,j as e,a as U,F as R}from"./index-EH-KDdP-.js";import{A as G}from"./arrow-left-BzqiXXya.js";import{C as q}from"./credit-card-BlaQXWoz.js";import{A as b}from"./alert-circle-BHhviexG.js";import{C as B}from"./check-circle-2-CJeBbnWO.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=w("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const h=w("Smartphone",[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]]),Q=()=>{const j=E(),[m,P]=n.useState([]),[_,u]=n.useState(!0),[i,t]=n.useState("list"),[l,f]=n.useState(null),[r,p]=n.useState(""),[o,y]=n.useState(""),[N,v]=n.useState(!1),[T,M]=n.useState(null);n.useEffect(()=>{const s=new URLSearchParams(window.location.search),a=s.get("status"),c=s.get("tx_ref");a&&c?C(a):g()},[]);const C=async(s,a)=>{v(!0),window.history.replaceState({},document.title,window.location.pathname),s==="successful"||s==="completed"?(t("success"),M("success"),await g()):(console.warn(`Payment failed with status: ${s}`),alert(`Payment was not successful. Status: ${s}. If you believe this is an error, please contact support.`),t("list")),v(!1)},g=async()=>{const s=sessionStorage.getItem("parentPhone");if(!s){j("/parents");return}u(!0);const{data:a,error:c}=await d.from("students").select("*").eq("parent_phone",s);if(c){console.error("Error fetching students:",c),u(!1);return}const A=await Promise.all((a||[]).map(async x=>{const{data:I}=await d.rpc("get_student_balance",{student_uuid:x.id}),{data:F}=await d.from("fee_payments").select("*").eq("student_id",x.id).order("created_at",{ascending:!1});return{...x,current_balance:I,transactions:F||[]}}));P(A),u(!1)},k=m.reduce((s,a)=>s+(a.current_balance||0),0),S=m.flatMap(s=>s.transactions).sort((s,a)=>new Date(a.created_at)-new Date(s.created_at)),z=s=>{f(s),t("amount")},X=()=>{if(!r||isNaN(r)||r<=0){alert("Please enter a valid amount");return}t("phone")},D=async()=>{if(!o||o.length<10){alert("Please enter a valid phone number");return}t("processing");try{const s=sessionStorage.getItem("parentPhone"),{data:a,error:c}=await d.functions.invoke("payment-init",{body:{amount:parseInt(r),student_id:l.id,student_name:l.student_name,phone:o,email:"parent@bugisuhighschool.com",name:"Parent"}});if(c)throw c;if(a.error)throw new Error(a.error);if(a.link)window.location.href=a.link;else throw new Error("No payment link received")}catch(s){console.error("Payment Error:",s),alert("Failed to initiate payment: "+s.message),t("list")}},L=()=>{t("list"),f(null),p(""),y("")};return _||N?e.jsx("div",{className:"fees-loading",children:N?"Verifying payment status...":"Loading financial records..."}):e.jsxs("div",{className:"parent-fees-container",children:[e.jsxs("header",{className:"fees-header",children:[e.jsx("button",{className:"back-btn",onClick:()=>i==="list"?j("/parents/portal"):t("list"),children:e.jsx(G,{size:20})}),e.jsx("h1",{children:i==="list"?"Fee Management":"Secure Payment"})]}),e.jsxs("div",{className:"fees-content",children:[i==="list"&&e.jsxs("div",{className:"fade-in",children:[e.jsxs("div",{className:"summary-card",children:[e.jsxs("div",{className:"summary-info",children:[e.jsx("span",{children:"Total Outstanding"}),e.jsxs("h2",{children:["UGX ",k.toLocaleString()]})]}),e.jsx("div",{className:"summary-icon",children:e.jsx(q,{size:32})})]}),e.jsxs("section",{className:"students-fees-section",children:[e.jsx("h3",{children:"Outstanding Balances"}),e.jsx("div",{className:"student-fee-list",children:m.map(s=>e.jsxs("div",{className:"student-fee-card",children:[e.jsxs("div",{className:"student-info",children:[e.jsx("h4",{children:s.student_name}),e.jsxs("p",{children:[s.class_grade," | ",s.student_reg_number]})]}),e.jsxs("div",{className:"balance-info",children:[e.jsx("span",{className:"balance-label",children:"Current Balance"}),e.jsxs("span",{className:"balance-amount",children:["UGX ",s.current_balance?s.current_balance.toLocaleString():"0"]})]}),e.jsxs("button",{className:"pay-now-btn",onClick:()=>z(s),children:["Pay Fees",e.jsx(U,{size:16})]})]},s.id))})]}),e.jsxs("section",{className:"history-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h3",{children:"Payment History"}),e.jsx(H,{size:18,color:"#6b7280"})]}),e.jsx("div",{className:"history-list",children:S.length>0?S.map(s=>e.jsxs("div",{className:"history-item",children:[e.jsx("div",{className:"tx-icon",children:e.jsx(R,{size:18,color:s.status==="completed"||s.status==="successful"?"#22c55e":"#f97316"})}),e.jsxs("div",{className:"tx-details",children:[e.jsx("span",{className:"tx-type",children:s.provider==="flutterwave"?"Mobile Money":"Cash Payment"}),e.jsx("span",{className:"tx-date",children:new Date(s.created_at).toLocaleDateString()}),s.status==="pending"&&e.jsx("small",{style:{color:"orange"},children:" (Pending)"})]}),e.jsxs("div",{className:"tx-amount",children:[e.jsxs("span",{className:"amount",children:["UGX ",s.amount_paid.toLocaleString()]}),e.jsx("span",{className:`status ${s.status==="successful"?"completed":s.status}`,children:s.status})]})]},s.id)):e.jsx("p",{style:{padding:"1rem",color:"#6b7280",fontSize:"0.9rem"},children:"No payment history found."})})]}),e.jsxs("section",{className:"quick-reference-section fade-in",children:[e.jsx("h3",{children:"Quick Reference (USSD)"}),e.jsxs("div",{className:"reference-grid",children:[e.jsxs("div",{className:"ref-card mtn",children:[e.jsxs("div",{className:"ref-header",children:[e.jsx(h,{size:16}),e.jsx("span",{children:"MTN MoMo"})]}),e.jsx("strong",{children:"*165*80#"}),e.jsxs("p",{children:["School Code: ",e.jsx("strong",{children:"BHS01"})]})]}),e.jsxs("div",{className:"ref-card airtel",children:[e.jsxs("div",{className:"ref-header",children:[e.jsx(h,{size:16}),e.jsx("span",{children:"Airtel Money"})]}),e.jsx("strong",{children:"*185*4*9#"}),e.jsxs("p",{children:["Merchant ID: ",e.jsx("strong",{children:"654321"})]})]})]}),e.jsxs("div",{className:"support-card",children:[e.jsx(b,{size:18,color:"#f97316"}),e.jsxs("div",{children:[e.jsx("p",{children:"Need help with payments?"}),e.jsx("small",{children:"Call Accountant: +256 700 000 000"})]})]})]})]}),i==="amount"&&e.jsx("div",{className:"payment-step fade-in",children:e.jsxs("div",{className:"step-card",children:[e.jsx("h3",{children:"Enter Amount"}),e.jsxs("p",{children:["Paying for: ",e.jsx("strong",{children:l.student_name})]}),e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"currency",children:"UGX"}),e.jsx("input",{type:"number",placeholder:"0.00",value:r,onChange:s=>p(s.target.value),autoFocus:!0})]}),e.jsx("div",{className:"quick-amounts",children:[5e4,1e5,2e5,5e5].map(s=>e.jsx("button",{onClick:()=>p(s),children:s.toLocaleString()},s))}),e.jsx("button",{className:"confirm-btn",onClick:X,children:"Continue"})]})}),i==="phone"&&e.jsx("div",{className:"payment-step fade-in",children:e.jsxs("div",{className:"step-card",children:[e.jsx("h3",{children:"Mobile Money Details"}),e.jsxs("p",{children:["Final Amount: ",e.jsxs("strong",{children:["UGX ",parseInt(r).toLocaleString()]})]}),e.jsx("div",{className:"provider-selector",children:e.jsxs("div",{className:"provider active",children:[e.jsx("div",{className:"dot"}),e.jsx("span",{children:"MTN MoMo / Airtel Money"})]})}),e.jsxs("div",{className:"input-field",children:[e.jsx("label",{children:"Phone Number"}),e.jsxs("div",{className:"phone-input",children:[e.jsx(h,{size:18}),e.jsx("input",{type:"tel",placeholder:"07XX XXX XXX",value:o,onChange:s=>y(s.target.value),autoFocus:!0})]})]}),e.jsxs("div",{className:"security-notice",children:[e.jsx(b,{size:14}),e.jsx("span",{style:{color:"#166534",fontWeight:"bold"},children:"You will be redirected to the secure payment page to complete the transaction."})]}),e.jsx("button",{className:"simulate-btn",onClick:D,children:"Pay Securely"})]})}),i==="processing"&&e.jsxs("div",{className:"processing-view fade-in",children:[e.jsxs("div",{className:"loader-container",children:[e.jsx("div",{className:"pulse-circle"}),e.jsx("div",{className:"pulse-circle delay"}),e.jsx(h,{size:48,className:"processing-icon"})]}),e.jsx("h3",{children:"Processing Payment"}),e.jsx("p",{children:"Waiting for you to authorize the transaction on your phone..."}),e.jsxs("div",{className:"processing-steps",children:[e.jsx("div",{className:"mini-step done",children:"Initiating transaction..."}),e.jsx("div",{className:"mini-step active",children:"Awaiting PIN entry..."})]})]}),i==="success"&&e.jsxs("div",{className:"success-view fade-in",children:[e.jsx("div",{className:"success-icon-wrapper",children:e.jsx(B,{size:80,color:"#22c55e"})}),e.jsx("h2",{children:"Payment Successful!"}),e.jsxs("p",{children:["Your payment of UGX ",parseInt(r).toLocaleString()," has been received."]}),e.jsxs("div",{className:"receipt-box",children:[e.jsxs("div",{className:"receipt-row",children:[e.jsx("span",{children:"Receipt ID"}),e.jsxs("strong",{children:["#BHS-",Math.floor(Math.random()*9e5)+1e5]})]}),e.jsxs("div",{className:"receipt-row",children:[e.jsx("span",{children:"Student"}),e.jsx("strong",{children:l.student_name})]}),e.jsxs("div",{className:"receipt-row",children:[e.jsx("span",{children:"Method"}),e.jsx("strong",{children:"Mobile Money"})]})]}),e.jsx("button",{className:"finish-btn",onClick:L,children:"Back to Dashboard"})]})]})]})};export{Q as default};
