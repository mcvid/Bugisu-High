import{r as m,s as j,j as e,X as D,a5 as O,S as J,F as K}from"./index-DnZapYtk.js";import{R as Q}from"./ReportCard-BoSYp_eB.js";import{I as Z}from"./ImportGuideModal-BEGhBwKn.js";import{read as ee,utils as te}from"./xlsx-D_0l8YDs.js";import{D as V}from"./download-BqOENLGe.js";import{U as re}from"./upload-BXbAIg_5.js";import{S as se}from"./save-BWmYaoU4.js";import{U as ne}from"./user-hLTyjqTW.js";import{P as ae}from"./pen-square-DK-NPVOX.js";import{T as le}from"./trash-2-CjA1UK2C.js";import"./award-BXANW5Rb.js";import"./activity-DoRaXrnd.js";import"./check-circle-2-D0MhmHkv.js";import"./check-circle-DznmAU8U.js";import"./x-circle-CV43t_Vp.js";const Se=()=>{const[C,L]=m.useState([]),[U,d]=m.useState(!0),[y,N]=m.useState(!1),[i,w]=m.useState({student_name:"",student_reg_number:"",house:"",class_grade:"",parent_name:"",parent_email:"",parent_phone:"",valid_until:"",photo_url:""}),[c,z]=m.useState({class_grade:"",search_query:""});m.useEffect(()=>{_()},[c.class_grade]);const _=async()=>{try{d(!0);let t=j.from("students").select("*").order("student_name",{ascending:!0});c.class_grade&&(t=t.eq("class_grade",c.class_grade));const{data:r,error:o}=await t;if(o)throw o;L(r||[])}catch(t){console.error("Error fetching students:",t),alert("Failed to fetch students")}finally{d(!1)}},A=C.filter(t=>t.student_name.toLowerCase().includes(c.search_query.toLowerCase())||t.student_reg_number.toLowerCase().includes(c.search_query.toLowerCase())),u=t=>{const{name:r,value:o}=t.target;w(n=>({...n,[r]:o}))},I=async t=>{t.preventDefault();try{const{error:r}=await j.from("students").upsert([i],{onConflict:"student_reg_number"});if(r)throw r;alert("Student saved successfully!"),N(!1),w({student_name:"",student_reg_number:"",house:"",class_grade:"",parent_name:"",parent_email:"",parent_phone:"",valid_until:"",photo_url:""}),_()}catch(r){console.error("Error saving student:",r),alert("Failed to save student: "+r.message)}},B=async t=>{if(window.confirm("Are you sure you want to delete this student?"))try{const{error:r}=await j.from("students").delete().eq("id",t);if(r)throw r;_()}catch(r){console.error("Error deleting student:",r),alert("Failed to delete student")}},T=()=>{if(!C.length){alert("No students to export.");return}const r=[["Name","Reg Number","House","Class","Parent Name","Parent Email","Parent Phone","Valid Until"].join(","),...C.map(a=>[`"${a.student_name}"`,`"${a.student_reg_number}"`,`"${a.house}"`,`"${a.class_grade}"`,`"${a.parent_name||""}"`,`"${a.parent_email||""}"`,`"${a.parent_phone||""}"`,`"${a.valid_until||""}"`].join(","))].join(`
`),o=new Blob([r],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),f=URL.createObjectURL(o);n.setAttribute("href",f),n.setAttribute("download",`students_export_${new Date().toISOString().split("T")[0]}.csv`),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n)},X=t=>{if(!t)return null;if(typeof t=="string"&&t.includes("-"))return t;if(typeof t=="number"){const o=Math.floor(t-25569)*86400,n=new Date(o*1e3),f=n.getFullYear(),a=String(n.getMonth()+1).padStart(2,"0"),h=String(n.getDate()).padStart(2,"0");return`${f}-${a}-${h}`}return null},G=async t=>{const r=t.target.files[0];if(!r)return;const o=r.name.toLowerCase(),n=o.endsWith(".xlsx")||o.endsWith(".xls"),f=o.endsWith(".csv");if(!n&&!f){alert("Please upload a valid Excel (.xlsx, .xls) or CSV (.csv) file."),t.target.value=null;return}d(!0);try{let a=[];if(n){const h=new FileReader;h.onload=async E=>{try{const p=E.target.result,x=ee(p,{type:"binary"}),P=x.SheetNames[0],F=x.Sheets[P],b=te.sheet_to_json(F);if(b.length===0){alert("File is empty."),d(!1);return}b.forEach(s=>{const l={student_name:s.student_name||s.Name||s["Student Name"],student_reg_number:s.student_reg_number||s["Reg Number"]||s["Registration Number"],house:s.house||s.House,class_grade:s.class_grade||s.Class||s.Grade,parent_name:s.parent_name||s["Parent Name"],parent_email:s.parent_email||s["Parent Email"]||s.Email,parent_phone:s.parent_phone||s["Parent Phone"]||s.Phone,valid_until:X(s.valid_until||s["Valid Until"])};l.student_name&&l.student_reg_number?a.push(l):console.warn("Skipping invalid row (missing Name or Reg Number):",s)}),await H(a)}catch(p){console.error("Excel import error:",p),alert("Failed to import Excel file: "+p.message),d(!1)}},h.readAsBinaryString(r)}else{const h=new FileReader;h.onload=async E=>{try{const x=E.target.result.split(`
`),P=x[0].split(",").map(s=>s.trim().replace(/^"|"$/g,"")),F=s=>{const l=s.toLowerCase();return l.includes("name")?"student_name":l.includes("reg")?"student_reg_number":l.includes("house")?"house":l.includes("class")?"class_grade":l.includes("parent name")?"parent_name":l.includes("email")?"parent_email":l.includes("phone")?"parent_phone":l.includes("valid")?"valid_until":null},b=P.map(F);for(let s=1;s<x.length;s++){if(!x[s].trim())continue;const l=x[s].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(S=>S.trim().replace(/^"|"$/g,"")),v={};let q=!0;b.forEach((S,Y)=>{S&&(v[S]=l[Y])}),(!v.student_name||!v.student_reg_number)&&(console.warn("Skipping invalid row (missing Name or Reg Number):",s+1,l),q=!1),q&&a.push(v)}await H(a)}catch(p){console.error("CSV import error:",p),alert("Failed to import CSV file: "+p.message),d(!1)}},h.readAsText(r)}}catch(a){console.error("Import error:",a),alert("Failed to import file: "+a.message),d(!1)}t.target.value=null},H=async t=>{if(t.length>0)try{const{error:r}=await j.from("students").upsert(t,{onConflict:"student_reg_number"});if(r)throw r;alert(`Successfully imported ${t.length} students!`),_()}catch(r){console.error("Database insert error:",r),alert("Failed to save students: "+r.message)}finally{d(!1)}else alert("No valid students found in file."),d(!1)},[g,R]=m.useState(null),[oe,$]=m.useState(!1),[M,k]=m.useState(!1),W=async t=>{$(!0);try{const r=new Date().getFullYear(),{data:o,error:n}=await j.from("grades").select("*, subjects(name, category)").eq("student_id",t.id).eq("year",r).order("created_at",{ascending:!1});if(n)throw n;R({student:t,grades:o||[],term:"Term 1",year:r})}catch(r){console.error("Error fetching report:",r),alert("Failed to load report card.")}finally{$(!1)}};return e.jsxs("div",{className:"admin-page-container",children:[g&&e.jsx("div",{className:"report-modal-overlay",onClick:()=>R(null),children:e.jsxs("div",{className:"report-modal-content",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"no-print",style:{padding:"1rem",display:"flex",justifyContent:"space-between",background:"#f1f5f9",borderBottom:"1px solid #e2e8f0"},children:[e.jsx("h3",{style:{margin:0},children:"Report Card Preview"}),e.jsxs("div",{style:{display:"flex",gap:"1rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:()=>window.print(),children:[e.jsx(V,{size:16})," Print Report"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>R(null),children:[e.jsx(D,{size:16})," Close"]})]})]}),e.jsx("div",{style:{padding:"1rem",overflow:"auto",maxHeight:"80vh"},children:e.jsx(Q,{student:g.student,grades:g.grades,term:g.term,year:g.year})})]})}),M&&e.jsx(Z,{type:"students",onClose:()=>k(!1),onProceed:()=>{k(!1),document.getElementById("students-file-input").click()}}),e.jsx("input",{id:"students-file-input",type:"file",accept:".csv,.xlsx,.xls",onChange:G,style:{display:"none"}}),e.jsxs("div",{className:"admin-header",children:[e.jsx("h2",{children:"Student Management"}),e.jsxs("div",{style:{display:"flex",gap:"10px"},children:[e.jsxs("label",{className:"btn btn-secondary",style:{display:"flex",alignItems:"center",gap:"8px",background:"#e0f2fe",color:"#0284c7",cursor:"pointer"},onClick:()=>k(!0),children:[e.jsx(re,{size:20}),"Import Students"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:T,style:{display:"flex",alignItems:"center",gap:"8px",background:"#f1f5f9",color:"#475569"},children:[e.jsx(V,{size:20}),"Export"]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>N(!y),children:[y?e.jsx(D,{size:20}):e.jsx(O,{size:20}),y?"Cancel":"Add Student"]})]})]}),y&&e.jsxs("div",{className:"admin-form-container",style:{marginBottom:"2rem",padding:"1.5rem",background:"white",borderRadius:"8px",boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},children:[e.jsx("h3",{children:"Add / Update Student"}),e.jsxs("form",{onSubmit:I,style:{display:"grid",gap:"1rem",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))"},children:[e.jsxs("div",{children:[e.jsx("label",{children:"Student Name *"}),e.jsx("input",{type:"text",name:"student_name",value:i.student_name,onChange:u,required:!0,className:"form-control"})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Reg Number *"}),e.jsx("input",{type:"text",name:"student_reg_number",value:i.student_reg_number,onChange:u,required:!0,className:"form-control",placeholder:"BHS/202X/XXXX"})]}),e.jsxs("div",{children:[e.jsx("label",{children:"House *"}),e.jsxs("select",{name:"house",value:i.house,onChange:u,required:!0,className:"form-control",children:[e.jsx("option",{value:"",children:"Select House"}),e.jsx("option",{value:"Elgon House",children:"Elgon House"}),e.jsx("option",{value:"Nile House",children:"Nile House"}),e.jsx("option",{value:"Victoria House",children:"Victoria House"}),e.jsx("option",{value:"Rwenzori House",children:"Rwenzori House"})]})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Class/Grade *"}),e.jsxs("select",{name:"class_grade",value:i.class_grade,onChange:u,required:!0,className:"form-control",children:[e.jsx("option",{value:"",children:"Select Class"}),e.jsx("option",{value:"Senior 1",children:"Senior 1"}),e.jsx("option",{value:"Senior 2",children:"Senior 2"}),e.jsx("option",{value:"Senior 3",children:"Senior 3"}),e.jsx("option",{value:"Senior 4",children:"Senior 4"}),e.jsx("option",{value:"Senior 5",children:"Senior 5"}),e.jsx("option",{value:"Senior 6",children:"Senior 6"})]})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Parent Name"}),e.jsx("input",{type:"text",name:"parent_name",value:i.parent_name,onChange:u,className:"form-control"})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Parent Email"}),e.jsx("input",{type:"email",name:"parent_email",value:i.parent_email,onChange:u,className:"form-control"})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Parent Phone"}),e.jsx("input",{type:"tel",name:"parent_phone",value:i.parent_phone,onChange:u,className:"form-control"})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Valid Until"}),e.jsx("input",{type:"date",name:"valid_until",value:i.valid_until,onChange:u,className:"form-control"})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Photo URL"}),e.jsx("input",{type:"text",name:"photo_url",value:i.photo_url,onChange:u,className:"form-control"})]}),e.jsx("div",{style:{gridColumn:"1 / -1",marginTop:"1rem"},children:e.jsxs("button",{type:"submit",className:"btn btn-primary",children:[e.jsx(se,{size:18})," Save Student"]})})]})]}),e.jsxs("div",{className:"filters-bar",style:{display:"flex",gap:"1rem",marginBottom:"1.5rem",background:"white",padding:"1rem",borderRadius:"8px",border:"1px solid #e2e8f0"},children:[e.jsxs("div",{style:{flex:1,position:"relative"},children:[e.jsx(J,{size:18,style:{position:"absolute",left:"12px",top:"50%",transform:"translateY(-50%)",color:"#94a3b8"}}),e.jsx("input",{type:"text",placeholder:"Search by name or reg number...",value:c.search_query,onChange:t=>z({...c,search_query:t.target.value}),style:{width:"100%",padding:"0.625rem 1rem 0.625rem 2.5rem",borderRadius:"6px",border:"1px solid #cbd5e1",fontSize:"0.95rem"}})]}),e.jsxs("select",{value:c.class_grade,onChange:t=>z({...c,class_grade:t.target.value}),style:{padding:"0.625rem 1rem",borderRadius:"6px",border:"1px solid #cbd5e1",fontSize:"0.95rem",minWidth:"150px"},children:[e.jsx("option",{value:"",children:"All Classes"}),e.jsx("option",{value:"Senior 1",children:"Senior 1"}),e.jsx("option",{value:"Senior 2",children:"Senior 2"}),e.jsx("option",{value:"Senior 3",children:"Senior 3"}),e.jsx("option",{value:"Senior 4",children:"Senior 4"}),e.jsx("option",{value:"Senior 5",children:"Senior 5"}),e.jsx("option",{value:"Senior 6",children:"Senior 6"})]})]}),e.jsx("div",{className:"students-list",children:U?e.jsx("p",{children:"Loading students..."}):e.jsx("div",{style:{overflowX:"auto"},children:e.jsxs("table",{className:"admin-table",style:{width:"100%",borderCollapse:"collapse",background:"white"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{borderBottom:"2px solid #eee",textAlign:"left"},children:[e.jsx("th",{style:{padding:"1rem"},children:"Name"}),e.jsx("th",{style:{padding:"1rem"},children:"Reg No"}),e.jsx("th",{style:{padding:"1rem"},children:"Class"}),e.jsx("th",{style:{padding:"1rem"},children:"House"}),e.jsx("th",{style:{padding:"1rem"},children:"Actions"})]})}),e.jsx("tbody",{children:A.map(t=>e.jsxs("tr",{style:{borderBottom:"1px solid #eee"},children:[e.jsx("td",{style:{padding:"1rem"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[t.photo_url?e.jsx("img",{src:t.photo_url,alt:"",style:{width:"30px",height:"30px",borderRadius:"50%",objectFit:"cover"}}):e.jsx(ne,{size:20}),t.student_name]})}),e.jsx("td",{style:{padding:"1rem"},children:t.student_reg_number}),e.jsx("td",{style:{padding:"1rem"},children:t.class_grade}),e.jsx("td",{style:{padding:"1rem"},children:t.house}),e.jsxs("td",{style:{padding:"1rem"},children:[e.jsx("button",{onClick:()=>W(t),className:"btn-icon",style:{marginRight:"0.5rem",color:"#6366f1"},title:"View Report Card",children:e.jsx(K,{size:18})}),e.jsx("button",{onClick:()=>{w(t),N(!0),window.scrollTo({top:0,behavior:"smooth"})},className:"btn-icon",style:{marginRight:"0.5rem",color:"blue"},children:e.jsx(ae,{size:18})}),e.jsx("button",{onClick:()=>B(t.id),className:"btn-icon",style:{color:"red"},children:e.jsx(le,{size:18})})]})]},t.id))})]})})})]})};export{Se as default};
