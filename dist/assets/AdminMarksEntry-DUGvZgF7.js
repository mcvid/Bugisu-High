import{r as u,s as m,j as e,F as ue,X as me,ac as $}from"./index-BwtYp3Ig.js";import{I as he}from"./ImportGuideModal-Dhdyz6D1.js";import{D as Y}from"./download-Bw_uiH9L.js";import{U as H}from"./upload-DHc5piML.js";import{S as pe}from"./save-BnUOIqxV.js";import"./check-circle-wKT-fa_O.js";import"./x-circle-OGGTiFg-.js";const ke=()=>{const[S,B]=u.useState([]),[I,D]=u.useState([]),[a,F]=u.useState({class_grade:"",subject_id:"",term:"Term 1",year:new Date().getFullYear()}),[w,P]=u.useState({}),[Q,g]=u.useState(!1),[z,N]=u.useState(!1),[T,_]=u.useState(null),[O,C]=u.useState(null),[U,V]=u.useState({}),[Z,K]=u.useState({});u.useEffect(()=>{(async()=>{if(!a.class_grade){const{data:n}=await m.from("subjects").select("*").order("name");D(n||[]);return}const{data:s,error:r}=await m.from("class_subjects").select("subject_id, subjects(*)").eq("class_name",a.class_grade);if(r)console.error("Error fetching class subjects:",r),D([]);else if(s){const n=s.map(l=>l.subjects).filter(l=>!!l).sort((l,o)=>l.name.localeCompare(o.name));D(n)}})()},[a.class_grade]),u.useEffect(()=>{!a.class_grade||!a.subject_id||X()},[a.class_grade,a.subject_id,a.term,a.year]);const X=async()=>{g(!0),_(null);try{const{data:t,error:s}=await m.from("students").select("id, student_name, student_reg_number").eq("class_grade",a.class_grade).order("student_name");if(s)throw s;const r=t.map(c=>c.id);if(r.length===0){B([]),g(!1);return}const{data:n,error:l}=await m.from("grades").select("*").in("student_id",r).eq("subject_id",a.subject_id).eq("term",a.term).eq("year",a.year);if(l)throw l;const o={};n.forEach(c=>{o[c.student_id]=c.marks}),B(t),P(o),ee(r)}catch(t){console.error("Error fetching data:",t),_({type:"error",text:"Failed to load data"})}finally{g(!1)}},ee=async t=>{try{const{data:s}=await m.from("report_metadata").select("*").in("student_id",t).eq("term",a.term).eq("year",a.year),r={};s==null||s.forEach(o=>{r[o.student_id]=o}),V(r);const{data:n}=await m.from("competencies").select("*").in("student_id",t).eq("term",a.term).eq("year",a.year),l={};n==null||n.forEach(o=>{l[o.student_id]||(l[o.student_id]=[]),l[o.student_id].push(o)}),K(l)}catch(s){console.error("Error fetching batch metadata:",s)}},te=(t,s)=>{P(r=>({...r,[t]:s}))},A=t=>{const s=parseInt(t);return isNaN(s)?"":s>=80?"A":s>=70?"B":s>=60?"C":s>=50?"D":s>=40?"E":"F"},se=async()=>{if(!a.subject_id)return;N(!0),_(null);const t=[];if(Object.entries(w).forEach(([s,r])=>{r!==""&&r!==void 0&&t.push({student_id:s,subject_id:a.subject_id,term:a.term,year:a.year,marks:parseInt(r),grade:A(r)})}),t.length===0){N(!1);return}try{const{error:s}=await m.from("grades").upsert(t,{onConflict:"student_id, subject_id, term, year"});if(s)throw s;_({type:"success",text:`Successfully saved ${t.length} grades!`})}catch(s){console.error("Save error:",s),_({type:"error",text:"Failed to save grades: "+s.message})}finally{N(!1)}},ae=async(t,s,r)=>{N(!0);try{const{error:n}=await m.from("report_metadata").upsert([{student_id:t,term:a.term,year:a.year,...s}],{onConflict:"student_id, term, year"});if(n)throw n;if(r.length>0){const l=r.map(c=>({student_id:t,term:a.term,year:a.year,skill_name:c.skill_name,achievement_level:c.achievement_level})),{error:o}=await m.from("competencies").upsert(l,{onConflict:"student_id, term, year, skill_name"});if(o)throw o}V(l=>({...l,[t]:s})),K(l=>({...l,[t]:r})),C(null),_({type:"success",text:"General remarks saved successfully!"})}catch(n){console.error("Error saving metadata:",n),alert("Failed to save general remarks")}finally{N(!1)}},re=(t,s)=>{if(t.key==="Enter"){t.preventDefault();const r=document.getElementById(`mark-input-${s+1}`);r&&(r.focus(),r.select())}},[fe,_e]=u.useState(null),[ne,G]=u.useState(!1),le=()=>{if(!S.length){alert("Please select a class and subject first.");return}const t=S.map(s=>({"Reg Number":s.student_reg_number,"Student Name":s.student_name,"Mark (0-100)":""}));$(()=>import("./xlsx-D_0l8YDs.js"),[]).then(s=>{var c;const r=s.utils.json_to_sheet(t),n=s.utils.book_new();s.utils.book_append_sheet(n,r,"Marks");const l=((c=I.find(i=>i.id===a.subject_id))==null?void 0:c.name)||"Subject",o=`${a.class_grade}_${l}_${a.term}_${a.year}_TEMPLATE.xlsx`.replace(/ /g,"_");s.writeFile(n,o)})},oe=t=>{const s=t.target.files[0];s&&$(()=>import("./xlsx-D_0l8YDs.js"),[]).then(r=>{const n=new FileReader;n.onload=l=>{const o=l.target.result,c=r.read(o,{type:"binary"}),i=c.SheetNames[0],j=c.Sheets[i],h=r.utils.sheet_to_json(j),p={...w};let f=0,y=0;h.forEach(R=>{const k=R["Reg Number"],v=R["Mark (0-100)"];if(k&&v!==void 0){const E=S.find(L=>L.student_reg_number===k);E?(p[E.id]=v,f++):(y++,console.warn(`Student with RegNo ${k} not found in current list.`))}}),f>0?(P(p),_({type:"success",text:`Imported ${f} marks! (${y} errors/not found)`})):alert("No matching students found in the file. Please ensure Reg Numbers match.")},n.readAsBinaryString(s),t.target.value=null})},ie=async t=>{const s=t.target.files[0];if(s){g(!0),_(null);try{const r=await $(()=>import("./xlsx-D_0l8YDs.js"),[]),n=new FileReader;n.onload=async l=>{try{const o=l.target.result,c=r.read(o,{type:"binary"}),i=c.SheetNames[0],j=c.Sheets[i],h=r.utils.sheet_to_json(j);if(h.length===0){alert("File is empty."),g(!1);return}const p=Object.keys(h[0]),f=p.find(d=>d.toLowerCase().includes("reg")||d.toLowerCase().includes("number")||d.toLowerCase().includes("id"));if(!f){alert("Could not find a Registration Number column in the Excel."),g(!1);return}const y={};I.forEach(d=>{y[d.name.toLowerCase()]=d.id,y[d.name.toLowerCase().replace(/\s/g,"")]=d.id});const{data:R}=await m.from("students").select("id, student_reg_number, class_grade"),k={};R.forEach(d=>{k[d.student_reg_number]=d.id});const v=[];let E=0,L=0;if(h.forEach(d=>{const q=d[f],J=k[q];if(!J){console.warn(`Student not found: ${q}`),E++;return}p.forEach(x=>{if(x===f||x.toLowerCase().includes("name")||x.toLowerCase().includes("student"))return;const b=d[x];if(b==null||b===""||b==="-"||b==="N/A"||b==="n/a"){L++;return}const W=y[x.toLowerCase()]||y[x.toLowerCase().replace(/\s/g,"")];if(!W){console.warn(`Subject not found in database: ${x}`);return}const M=parseInt(b);if(isNaN(M)||M<0||M>100){console.warn(`Invalid mark value: ${b} for ${q} in ${x}`);return}v.push({student_id:J,subject_id:W,term:a.term,year:a.year,marks:M,grade:A(M)})})}),v.length>0){const{error:d}=await m.from("grades").upsert(v,{onConflict:"student_id, subject_id, term, year"});if(d)throw d;_({type:"success",text:`Imported ${v.length} grades successfully! (Skipped ${E} students, ${L} empty/optional marks)`})}else alert("No valid grades found in the file.")}catch(o){console.error("Multi-subject import error:",o),alert("Import failed: "+o.message)}finally{g(!1),t.target.value=null}},n.readAsBinaryString(s)}catch(r){console.error("Import error:",r),g(!1)}}},ce=async()=>{if(!a.class_grade){alert("Please select a class first.");return}const{data:t}=await m.from("students").select("student_reg_number, student_name").eq("class_grade",a.class_grade).order("student_name");if(!t||t.length===0){alert("No students found in this class.");return}const{data:s,error:r}=await m.from("class_subjects").select("subject_id, is_compulsory, subjects(id, name, category)").eq("class_name",a.class_grade).order("is_compulsory",{ascending:!1}),n=s&&s.length>0?s.map(h=>h.subjects):I;if(n.length===0){alert("No subjects configured for this class. Please set up class-subject mappings in the database.");return}const l=t.map(h=>{const p={"Reg Number":h.student_reg_number,"Student Name":h.student_name};return n.forEach(f=>{f&&f.name&&(p[f.name]="")}),p}),o=await $(()=>import("./xlsx-D_0l8YDs.js"),[]),c=o.utils.json_to_sheet(l),i=o.utils.book_new();o.utils.book_append_sheet(i,c,"All_Marks");const j=`${a.class_grade}_ALL_SUBJECTS_${a.term}_${a.year}_TEMPLATE.xlsx`.replace(/ /g,"_");o.writeFile(i,j)},de=({student:t})=>{const s=U[t.id]||{attendance_present:0,attendance_total:90,conduct_rating:"Good",responsibility_rating:"Satisfactory",punctuality_rating:"Good",teacher_remark:"",headteacher_remark:""},r=Z[t.id]||[{skill_name:"Communication",achievement_level:"Meets Expectations"},{skill_name:"Critical Thinking",achievement_level:"Meets Expectations"},{skill_name:"Collaboration",achievement_level:"Meets Expectations"},{skill_name:"Creativity",achievement_level:"Meets Expectations"}],[n,l]=u.useState(s),[o,c]=u.useState(r);return e.jsx("div",{className:"modal-overlay",onClick:()=>C(null),children:e.jsxs("div",{className:"modal-content remarks-modal",onClick:i=>i.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h3",{children:["General Assessment: ",t.student_name]}),e.jsx("button",{className:"close-btn",onClick:()=>C(null),children:e.jsx(me,{size:20})})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"admin-form-group",children:[e.jsx("label",{children:"Attendance (Days Present / Total)"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("input",{type:"number",className:"form-control",value:n.attendance_present,onChange:i=>l({...n,attendance_present:parseInt(i.target.value)})}),e.jsx("span",{children:"/"}),e.jsx("input",{type:"number",className:"form-control",value:n.attendance_total,onChange:i=>l({...n,attendance_total:parseInt(i.target.value)})})]})]}),e.jsxs("div",{className:"admin-form-row",children:[e.jsxs("div",{children:[e.jsx("label",{children:"Conduct"}),e.jsxs("select",{className:"form-control",value:n.conduct_rating,onChange:i=>l({...n,conduct_rating:i.target.value}),children:[e.jsx("option",{children:"Excellent"}),e.jsx("option",{children:"Good"}),e.jsx("option",{children:"Satisfactory"}),e.jsx("option",{children:"Needs Improvement"})]})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Punctuality"}),e.jsxs("select",{className:"form-control",value:n.punctuality_rating,onChange:i=>l({...n,punctuality_rating:i.target.value}),children:[e.jsx("option",{children:"Excellent"}),e.jsx("option",{children:"Good"}),e.jsx("option",{children:"Satisfactory"}),e.jsx("option",{children:"Needs Improvement"})]})]})]}),e.jsxs("div",{className:"competencies-entry-list",style:{marginTop:"1rem"},children:[e.jsx("label",{children:"Core Competencies"}),o.map((i,j)=>e.jsxs("div",{className:"comp-entry-row",style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.9rem"},children:i.skill_name}),e.jsxs("select",{className:"form-control",style:{width:"auto"},value:i.achievement_level,onChange:h=>{const p=[...o];p[j].achievement_level=h.target.value,c(p)},children:[e.jsx("option",{children:"Exceeds Expectations"}),e.jsx("option",{children:"Meets Expectations"}),e.jsx("option",{children:"Approaching Expectations"}),e.jsx("option",{children:"Needs Support"})]})]},j))]}),e.jsxs("div",{style:{marginTop:"1rem"},children:[e.jsx("label",{children:"Class Teacher's Remark"}),e.jsx("textarea",{className:"form-control",value:n.teacher_remark,onChange:i=>l({...n,teacher_remark:i.target.value}),rows:"3"})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>C(null),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:()=>ae(t.id,n,o),children:z?"Saving...":"Save Assessment"})]})]})})};return e.jsxs("div",{className:"admin-page-container",children:[O&&e.jsx(de,{student:O}),ne&&e.jsx(he,{type:"grades",onClose:()=>G(!1),onProceed:()=>{G(!1),document.getElementById("grades-file-input").click()}}),e.jsx("input",{id:"grades-file-input",type:"file",accept:".xlsx, .xls",onChange:oe,style:{display:"none"}}),e.jsxs("div",{className:"admin-header",children:[e.jsx("h2",{children:"Enter Student Marks"}),e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center"},children:[a.class_grade&&e.jsx(e.Fragment,{children:e.jsxs("div",{style:{borderRight:"1px solid #ddd",paddingRight:"1rem",marginRight:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b",display:"block",marginBottom:"2px"},children:"All Subjects"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-outline btn-sm",onClick:ce,title:"Download template with ALL subjects",children:[e.jsx(Y,{size:14})," Full Template"]}),e.jsxs("label",{className:"btn btn-outline btn-sm",style:{cursor:"pointer"},children:[e.jsx(H,{size:14})," Import All",e.jsx("input",{type:"file",accept:".xlsx, .xls",onChange:ie,style:{display:"none"}})]})]})]})}),a.class_grade&&a.subject_id&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-outline",onClick:le,title:"Download Excel Template",children:[e.jsx(Y,{size:18})," Template"]}),e.jsxs("label",{className:"btn btn-outline",style:{cursor:"pointer"},title:"Upload Filled Excel",onClick:()=>G(!0),children:[e.jsx(H,{size:18})," Import"]})]}),T&&e.jsxs("div",{style:{color:T.type==="error"?"#ef4444":"#16a34a",display:"flex",alignItems:"center",gap:"5px",fontSize:"0.9rem"},children:[T.type==="error"?e.jsx(AlertCircle,{size:16}):e.jsx(CheckCircle,{size:16}),T.text]}),e.jsx("button",{className:"btn btn-primary",onClick:se,disabled:z||S.length===0,children:z?"Saving...":e.jsxs(e.Fragment,{children:[e.jsx(pe,{size:18})," Save All"]})})]})]}),e.jsxs("div",{className:"filters-bar",children:[e.jsxs("select",{value:a.class_grade,onChange:t=>F({...a,class_grade:t.target.value,subject_id:""}),className:"filter-select",children:[e.jsx("option",{value:"",children:"Select Class..."}),e.jsx("option",{value:"Senior 1",children:"Senior 1"}),e.jsx("option",{value:"Senior 2",children:"Senior 2"}),e.jsx("option",{value:"Senior 3",children:"Senior 3"}),e.jsx("option",{value:"Senior 4",children:"Senior 4"}),e.jsx("option",{value:"Senior 5",children:"Senior 5"}),e.jsx("option",{value:"Senior 6",children:"Senior 6"})]}),e.jsxs("select",{value:a.subject_id,onChange:t=>F({...a,subject_id:t.target.value}),className:"filter-select",children:[e.jsx("option",{value:"",children:"Select Subject..."}),I.map(t=>e.jsxs("option",{value:t.id,children:[t.name," (",t.category,")"]},t.id))]}),e.jsxs("select",{value:a.term,onChange:t=>F({...a,term:t.target.value}),className:"filter-select",children:[e.jsx("option",{value:"Term 1",children:"Term 1"}),e.jsx("option",{value:"Term 2",children:"Term 2"}),e.jsx("option",{value:"Term 3",children:"Term 3"})]})]}),Q?e.jsx("div",{style:{textAlign:"center",padding:"2rem"},children:"Loading students..."}):S.length>0?e.jsx("div",{className:"marks-grid",children:e.jsxs("table",{className:"admin-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Student Name"}),e.jsx("th",{children:"Reg No"}),e.jsx("th",{style:{width:"130px"},children:"Marks (0-100)"}),e.jsx("th",{children:"Grade"}),e.jsx("th",{children:"General Remarks"})]})}),e.jsx("tbody",{children:S.map((t,s)=>e.jsxs("tr",{children:[e.jsx("td",{children:t.student_name}),e.jsx("td",{style:{color:"#64748b",fontSize:"0.85rem"},children:t.student_reg_number}),e.jsx("td",{children:e.jsx("input",{id:`mark-input-${s}`,type:"number",min:"0",max:"100",value:w[t.id]||"",onChange:r=>te(t.id,r.target.value),onKeyDown:r=>re(r,s),className:"mark-input",placeholder:"-"})}),e.jsx("td",{style:{fontWeight:"bold",color:A(w[t.id])==="F"?"red":"green"},children:A(w[t.id])}),e.jsx("td",{children:e.jsxs("button",{className:"btn btn-outline btn-sm",onClick:()=>C(t),style:{display:"flex",alignItems:"center",gap:"5px"},children:[e.jsx(ue,{size:14}),U[t.id]?"Edit Remarks":"Add Remarks"]})})]},t.id))})]})}):e.jsx("div",{style:{textAlign:"center",padding:"3rem",color:"#64748b"},children:a.class_grade&&a.subject_id?"No students found in this class.":"Please select a Class and Subject to enter marks."})]})};export{ke as default};
